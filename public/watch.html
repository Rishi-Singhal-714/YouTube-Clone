<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Video - YouTube Clone</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="index.html" class="logo">
                <i class="fab fa-youtube"></i>
                <span>YouTube Clone</span>
            </a>
        </div>
        <div class="nav-center">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search...">
                <button id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div class="nav-right">
            <div id="userMenu">
                <!-- User menu will be loaded by auth.js -->
            </div>
        </div>
    </nav>

    <div class="container watch-container">
        <main class="video-player-section">
            <div id="videoPlayer">
                <!-- YouTube embed will go here -->
            </div>
            
            <div class="video-info" id="videoInfo">
                <!-- Video info will be loaded here -->
            </div>
            
            <div class="video-description">
                <h3>Description</h3>
                <p id="videoDescription"></p>
            </div>
        </main>
        
        <aside class="video-sidebar">
            <h3>Related Videos</h3>
            <div id="relatedVideos">
                <!-- Related videos will be loaded here -->
            </div>
        </aside>
    </div>

    <script src="auth.js"></script>
    <script>
        // Get video ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('v');
        
        if (!videoId) {
            window.location.href = 'index.html';
        }
        
        async function loadVideo() {
            try {
                // Load video details
                const response = await fetch(`/api/video/${videoId}`);
                const video = await response.json();
                
                // Embed YouTube video
                document.getElementById('videoPlayer').innerHTML = `
                    <iframe 
                        width="100%" 
                        height="500" 
                        src="https://www.youtube.com/embed/${videoId}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                `;
                
                // Display video info
                document.getElementById('videoInfo').innerHTML = `
                    <h2>${video.title}</h2>
                    <div class="video-stats">
                        <span><i class="fas fa-eye"></i> ${parseInt(video.viewCount).toLocaleString()} views</span>
                        <span><i class="fas fa-thumbs-up"></i> ${parseInt(video.likeCount).toLocaleString()} likes</span>
                        <span><i class="fas fa-clock"></i> ${new Date(video.publishedAt).toLocaleDateString()}</span>
                    </div>
                `;
                
                document.getElementById('videoDescription').textContent = video.description;
                
                // Add to history if user is logged in
                const token = localStorage.getItem('token');
                if (token) {
                    await fetch('/api/history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            video_id: videoId,
                            video_title: video.title,
                            thumbnail_url: video.thumbnail,
                            action_type: 'watch'
                        })
                    });
                }
                
                // Load related videos (simple search by title)
                const searchResponse = await fetch(`/api/search?q=${encodeURIComponent(video.title)}&maxResults=10`);
                const relatedVideos = await searchResponse.json();
                
                const relatedHtml = relatedVideos
                    .filter(v => v.id !== videoId)
                    .map(video => `
                        <div class="video-item" onclick="window.location.href='watch.html?v=${video.id}'">
                            <img src="${video.thumbnail}" alt="${video.title}">
                            <div class="video-details">
                                <h4>${video.title.substring(0, 50)}${video.title.length > 50 ? '...' : ''}</h4>
                                <p>${video.channelTitle}</p>
                            </div>
                        </div>
                    `).join('');
                
                document.getElementById('relatedVideos').innerHTML = relatedHtml;
                
            } catch (error) {
                console.error('Error loading video:', error);
                document.getElementById('videoPlayer').innerHTML = '<p>Error loading video. Please try again.</p>';
            }
        }
        
        loadVideo();
    </script>
</body>
</html>
